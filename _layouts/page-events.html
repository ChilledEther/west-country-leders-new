---
layout: default
---

<div class="page-events-content">
  <h1>
    {{ page.title }}
  </h1>
  <article>
    {{ content }}
  </article>

  <!-- JS-dependent text (managed in layout, not in content file) -->
  <p class="events-description">
    <span class="js-events-text"><strong>Displayed below are our upcoming gatherings for the next 3 months:</strong></span>
    <noscript>
      <style>.js-events-text { display: none !important; }</style>
      <strong>Displayed below is our event calendar:</strong>
    </noscript>
  </p>

  <div id="dynamic-events-container" class="events-grid">
    <!-- Dynamic events will be injected here -->
    <div id="events-loading" style="text-align: center; padding: 40px; grid-column: 1 / -1;">
      <i class="fa-solid fa-dice-d20 fa-spin" style="font-size: 3rem; color: #d4a76a;"></i>
      <p style="margin-top: 15px; color: #6e4c2f; font-weight: bold;">Unrolling the scrolls...</p>
    </div>
  </div>

  <div id="static-calendar-container" style="display: none;" class="responsive-iframe-container">
    <iframe src="https://calendar.google.com/calendar/embed?src=westcountryleders%40gmail.com&height=600&wkst=1&ctz=Europe%2FLondon&showPrint=0&hl=en_GB&showCalendars=0&showTabs=0&mode=AGENDA&src=d2VzdGNvdW50cnlsZWRlcnNAZ21haWwuY29t&color=%234285F4" style="border-width:0" width="100%" height="600" frameborder="0" scrolling="no"></iframe>
  </div>
</div>

<script>
  (function() {
    // Inject configuration from _config.yml
    const badgeRules = {{ site.events_badges | jsonify }};
    
    const calendarEmail = "westcountryleders@gmail.com";
    const icalUrl = "https://calendar.google.com/calendar/ical/" + encodeURIComponent(calendarEmail) + "/public/basic.ics";
    const proxyUrl = "https://corsproxy.io/?" + encodeURIComponent(icalUrl);
    
    const container = document.getElementById('dynamic-events-container');
    const loading = document.getElementById('events-loading');
    const staticCalendar = document.getElementById('static-calendar-container');

    function showFallback() {
      if (loading) loading.style.display = 'none';
      if (container && container.children.length <= 1) { 
        if (staticCalendar) staticCalendar.style.display = 'block';
        if (container) container.style.display = 'none';
      }
    }

    const safetyTimer = setTimeout(showFallback, 5000);

    function parseIcsDate(icsDate) {
      if (!icsDate) return null;
      const val = icsDate.trim();
      const year = val.substring(0, 4);
      const month = parseInt(val.substring(4, 6)) - 1;
      const day = val.substring(6, 8);
      
      let hour = 0, min = 0;
      if (val.length > 8 && val.includes('T')) {
          hour = val.substring(9, 11);
          min = val.substring(11, 13);
      }
      
      return new Date(Date.UTC(year, month, day, hour, min));
    }

    function formatEventDate(date) {
      return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
    }

    function formatEventTime(date) {
      return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
    }

    function determineBadge(summary, description) {
      const text = (summary + " " + (description || "")).toLowerCase();
      
      // 1. Check for explicit [Badge: Type] tag in description or title
      const explicitMatch = text.match(/\[badge:\s*([^\]]+)\]/i);
      if (explicitMatch && explicitMatch[1]) {
        return { text: explicitMatch[1].trim(), type: 'custom' }; // Default orange for custom unless we map it, but staying simple
      }

      // 2. Check Configured Rules
      if (badgeRules && Array.isArray(badgeRules)) {
        for (const rule of badgeRules) {
          if (rule.keywords && Array.isArray(rule.keywords)) {
            // Check if any keyword exists in the text
            if (rule.keywords.some(keyword => text.includes(keyword.toLowerCase()))) {
              return { text: rule.text, type: rule.style || 'default' };
            }
          }
        }
      }

      // Default
      return { text: 'Event', type: 'default' };
    }

    fetch(proxyUrl)
      .then(res => {
        if (!res.ok) throw new Error('Proxy error');
        return res.text();
      })
      .then(content => {
        clearTimeout(safetyTimer);
        
        if (!content || !content.includes('BEGIN:VEVENT')) {
          showFallback();
          return;
        }

        const unfoldedContent = content.replace(/\r\n[ \t]/g, '').replace(/\n[ \t]/g, '');
        const chunks = unfoldedContent.split('BEGIN:VEVENT');
        const now = new Date();
        now.setHours(0,0,0,0);
        
        const maxDate = new Date();
        maxDate.setMonth(now.getMonth() + 3);

        const events = [];

        for (let i = 1; i < chunks.length; i++) {
          const chunk = chunks[i];
          const summary = (chunk.match(/SUMMARY(?:;[^:]*)?:([^\r\n]+)/) || [])[1];
          const dtstart = (chunk.match(/DTSTART(?:;[^:]*)?:([^\r\n]+)/) || [])[1];
          const location = (chunk.match(/LOCATION(?:;[^:]*)?:([^\r\n]+)/) || [])[1];
          const description = (chunk.match(/DESCRIPTION(?:;[^:]*)?:(.*?)(\r\n|\n)[A-Z]+:/s) || [])[1] || "";

          if (dtstart) {
            const start = parseIcsDate(dtstart);
            if (start && start >= now && start <= maxDate) {
              events.push({
                title: (summary || "Event").trim().replace(/\\/g, ''),
                start: start,
                location: (location || "Bristol").trim().replace(/\\,/g, ',').replace(/\\/g, ''),
                description: description.replace(/\\n/g, ' ').replace(/\\/g, '')
              });
            }
          }
        }

        events.sort((a, b) => a.start - b.start);

        if (events.length > 0) {
          if (loading) loading.style.display = 'none';
          
          events.forEach(evt => {
            const badge = determineBadge(evt.title, evt.description);
            
            let badgeClass = 'card-header-badge';
            if (badge.type === 'tournament') badgeClass += ' badge-tournament';
            if (badge.type === 'social') badgeClass += ' badge-social';

            const wrapper = document.createElement('div');
            wrapper.className = 'event-card-wrapper';
            
            wrapper.innerHTML = `
              <div class="event-card">
                <div class="${badgeClass}">${badge.text}</div>
                <div class="card-content">
                  <div class="event-title">${evt.title}</div>
                  <div class="event-location">
                    <i class="fa-solid fa-map-pin"></i> ${evt.location}
                  </div>
                  <div class="stat-block">
                     <div class="stat-box">
                        <span class="stat-label">Date</span>
                        <span class="stat-value">${formatEventDate(evt.start)}</span>
                     </div>
                     <div class="stat-box">
                        <span class="stat-label">Time</span>
                        <span class="stat-value">${formatEventTime(evt.start)}</span>
                     </div>
                  </div>
                </div>
              </div>
            `;
            
            container.appendChild(wrapper);
          });
        } else {
          showFallback();
        }
      })
      .catch(err => {
        console.error("Events fetch error:", err);
        showFallback();
      });
  })();
</script>
