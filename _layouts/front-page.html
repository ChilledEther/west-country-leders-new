---
layout: default
---

<div class="container">
  <section class="hero-section">
    <div id="dynamic-notice-board" class="notice-board-container">
      <div class="notice-pin-wrapper">
        <i class="fa-solid fa-thumbtack notice-pin"></i>
      </div>
      <div class="notice-card">
        <div class="notice-content">
          <h2 id="notice-status">Next Gathering</h2>
          
          <div id="event-loading-spinner" style="text-align: center; padding: 10px;">
            <i class="fa-solid fa-dice-d20 fa-spin" style="font-size: 1.5rem; color: #d4a76a;"></i>
          </div>
          
          <div id="event-display-area" class="event-details" style="display: none;">
            <div class="event-info">
              <h3 id="event-title-display">Pending...</h3>
              <p id="event-meta-display" class="event-meta">
                <span><i class="fa-solid fa-calendar-days"></i> <span id="event-date-display">...</span></span>
                <span><i class="fa-solid fa-location-dot"></i> <span id="event-venue-display">...</span></span>
              </p>
            </div>
            <div class="event-action">
              <a href="{{ '/events' | relative_url }}" class="event-button">
                Calendar
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="hero-glass-card">
      <img src="{{ site.baseurl }}/assets/img/wcl-mascot.png" class="hero-mascot" alt="West Country Leders Mascot">
      <div class="hero-content">
        <h1>{{ page.title }}</h1>
        {{ content }}
      </div>
    </div>
  </section>

  <script>
    (function() {
      const calendarEmail = "westcountryleders@gmail.com";
      // Using an alternative CORS proxy that's often more reliable
      const icalUrl = "https://calendar.google.com/calendar/ical/" + encodeURIComponent(calendarEmail) + "/public/basic.ics";
      const proxyUrl = "https://corsproxy.io/?" + encodeURIComponent(icalUrl);
      
      const spinner = document.getElementById('event-loading-spinner');
      const displayArea = document.getElementById('event-display-area');
      const titleEl = document.getElementById('event-title-display');
      const dateEl = document.getElementById('event-date-display');
      const venueEl = document.getElementById('event-venue-display');

      function showFallback() {
        if (spinner) spinner.style.display = 'none';
        if (displayArea) displayArea.style.display = 'flex';
      }

      // Safety timeout: If it takes more than 4 seconds, just show the fallback
      const safetyTimer = setTimeout(showFallback, 4000);

      function parseIcsDate(icsDate) {
        if (!icsDate) return null;
        const val = icsDate.trim();
        const year = val.substring(0, 4);
        const month = parseInt(val.substring(4, 6)) - 1;
        const day = val.substring(6, 8);
        const hour = val.includes('T') ? val.substring(9, 11) : 0;
        const min = val.includes('T') ? val.substring(11, 13) : 0;
        return new Date(Date.UTC(year, month, day, hour, min));
      }

      function formatDisplayDate(date) {
        return date.toLocaleDateString('en-GB', { 
          weekday: 'long', 
          day: 'numeric', 
          month: 'long', 
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      fetch(proxyUrl)
        .then(function(res) { 
          if (!res.ok) throw new Error('Proxy error');
          return res.text(); 
        })
        .then(function(content) {
          clearTimeout(safetyTimer);
          if (!content || !content.includes('BEGIN:VEVENT')) {
            showFallback();
            return;
          }

          // Unfold the ICS content (handle line folding)
          // Lines starting with whitespace are continuations of the previous line
          const unfoldedContent = content.replace(/\r\n[ \t]/g, '').replace(/\n[ \t]/g, '');

          const events = [];
          const chunks = unfoldedContent.split('BEGIN:VEVENT');
          const now = new Date();

          for (let i = 1; i < chunks.length; i++) {
            const chunk = chunks[i];
            // Regex to capture value after property name
            const summary = (chunk.match(/SUMMARY(?:;[^:]*)?:([^\r\n]+)/) || [])[1];
            const dtstart = (chunk.match(/DTSTART(?:;[^:]*)?:([^\r\n]+)/) || [])[1];
            const location = (chunk.match(/LOCATION(?:;[^:]*)?:([^\r\n]+)/) || [])[1];

            if (dtstart) {
              const start = parseIcsDate(dtstart);
              if (start && start >= now) {
                events.push({
                  title: (summary || "Unnamed Event").trim().replace(/\\/g, ''),
                  start: start,
                  location: (location || "Check Discord").trim().replace(/\\,/g, ',').replace(/\\/g, '')
                });
              }
            }
          }

          events.sort(function(a, b) { return a.start - b.start; });

          if (events.length > 0) {
            const next = events[0];
            titleEl.textContent = next.title;
            dateEl.textContent = formatDisplayDate(next.start);
            venueEl.textContent = next.location;
            descEl.textContent = "";
          }
          showFallback();
        })
        .catch(function(err) {
          console.error("Calendar fetch error:", err);
          clearTimeout(safetyTimer);
          showFallback();
        });
    })();
  </script>
</div>
