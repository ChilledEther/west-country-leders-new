---
layout: default
---

<section class="hero-section">
    <!-- Next Event Banner - flows naturally, no overlap -->
    <div id="next-event-banner" class="next-event-banner">
      <div class="event-banner-icon">
        <i class="fa-solid fa-dice-d20"></i>
      </div>
      <div class="event-banner-content">
        <span class="event-banner-label">Next Gathering:</span>
        <span id="event-banner-title" class="event-banner-title">
          <i class="fa-solid fa-dice-d20 fa-spin" style="font-size: 0.9rem;"></i>
        </span>
        <span id="event-banner-date" class="event-banner-date"></span>
      </div>
      <a href="{{ '/events' | relative_url }}" class="event-banner-button">
        <i class="fa-solid fa-calendar-days"></i>
        <span>Events</span>
      </a>
    </div>

    <!-- Main Hero Card -->
    <div class="hero-glass-card">
      <div class="hero-content">
        <h1>{{ page.title }}</h1>
        {{ content }}
      </div>
    </div>
  </section>

  <script>
    (function() {
      const calendarEmail = "westcountryleders@gmail.com";
      const icalUrl = "https://calendar.google.com/calendar/ical/" + encodeURIComponent(calendarEmail) + "/public/basic.ics";
      const proxyUrl = "https://corsproxy.io/?" + encodeURIComponent(icalUrl);
      
      const titleEl = document.getElementById('event-banner-title');
      const dateEl = document.getElementById('event-banner-date');

      function showFallback() {
        // Show a default message if loading fails
        if (titleEl) titleEl.textContent = 'Check our calendar!';
      }

      // Safety timeout
      const safetyTimer = setTimeout(showFallback, 4000);

      function parseIcsDate(icsDate) {
        if (!icsDate) return null;
        const val = icsDate.trim();
        const year = val.substring(0, 4);
        const month = parseInt(val.substring(4, 6)) - 1;
        const day = val.substring(6, 8);
        const hour = val.includes('T') ? val.substring(9, 11) : 0;
        const min = val.includes('T') ? val.substring(11, 13) : 0;
        return new Date(Date.UTC(year, month, day, hour, min));
      }

      function formatShortDate(date) {
        return date.toLocaleDateString('en-GB', { 
          weekday: 'short', 
          day: 'numeric', 
          month: 'short',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      fetch(proxyUrl)
        .then(function(res) { 
          if (!res.ok) throw new Error('Proxy error');
          return res.text(); 
        })
        .then(function(content) {
          clearTimeout(safetyTimer);
          if (!content || !content.includes('BEGIN:VEVENT')) {
            showFallback();
            return;
          }

          const unfoldedContent = content.replace(/\r\n[ \t]/g, '').replace(/\n[ \t]/g, '');
          const events = [];
          const chunks = unfoldedContent.split('BEGIN:VEVENT');
          const now = new Date();

          for (let i = 1; i < chunks.length; i++) {
            const chunk = chunks[i];
            const summary = (chunk.match(/SUMMARY(?:;[^:]*)?:([^\r\n]+)/) || [])[1];
            const dtstart = (chunk.match(/DTSTART(?:;[^:]*)?:([^\r\n]+)/) || [])[1];

            if (dtstart) {
              const start = parseIcsDate(dtstart);
              if (start && start >= now) {
                events.push({
                  title: (summary || "Event").trim().replace(/\\/g, ''),
                  start: start
                });
              }
            }
          }

          events.sort(function(a, b) { return a.start - b.start; });

          if (events.length > 0) {
            const next = events[0];
            if (titleEl) titleEl.textContent = next.title;
            if (dateEl) dateEl.textContent = 'â€¢ ' + formatShortDate(next.start);
          } else {
            showFallback();
          }
        })
        .catch(function(err) {
          console.error("Calendar fetch error:", err);
          clearTimeout(safetyTimer);
          showFallback();
        });
    })();
  </script>


